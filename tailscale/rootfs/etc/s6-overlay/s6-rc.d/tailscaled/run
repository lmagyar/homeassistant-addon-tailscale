#!/command/with-contenv bashio
# shellcheck shell=bash
# ==============================================================================
# Home Assistant Community Add-on: Tailscale
# Runs tailscale
# ==============================================================================

readonly TAILSCALED_LOGLEVEL_NOTICE="Tailscale logs will be suppressed after 200 lines, set add-on's configuration option 'log_level' to 'debug' to see further logs"
readonly TAILSCALED_LOGLEVEL_MESSAGE="[further tailscaled logs suppressed, set add-on's configuration option 'log_level' to 'debug' to see further tailscaled logs]"

declare -a options
declare udp_port
declare tailscaled_gid

bashio::log.info 'Starting Tailscale...'

# Remove stale directories/files due to --statedir=/data/state changed in v0.9.0.1
rm -f /data/derpmap.cached.json
rm -rf /data/certs/*
rm -rf /data/files/*
rm -rf /data/ssh/*
[[ -d /data/certs/ ]] && rmdir /data/certs
[[ -d /data/files/ ]] && rmdir /data/files
[[ -d /data/ssh/ ]] && rmdir /data/ssh

options+=(--state=/data/tailscaled.state)
options+=(--statedir=/data/state)

# Opt out of client log upload to log.tailscale.io
if ! bashio::debug ; then
  options+=(--no-logs-no-support)
fi

# Use configured UDP port
udp_port=$(bashio::addon.port "41641/udp")
if bashio::var.has_value "${udp_port}"; then
  options+=(--port=${udp_port})
fi

# Use userspace networking by default when not set, or when explicitly enabled
if ! bashio::config.has_value "userspace_networking" || \
  bashio::config.true "userspace_networking";
then
  options+=(--tun=userspace-networking)
fi

function setup_dscp() {
  local ip_version="$1"
  local iface
  local dscp_value

  # Get the primary interface using bashio and jq
  iface=$(bashio::network.interface | jq -r ' .interface')
  dscp_value=$(bashio::config "dscp")

  bashio::log.info "Setting DSCP for tailscaled (${ip_version})"
  
  # Check if qdisc already exists
  if ! tc qdisc show dev "${iface}" | grep -q "htb"; then
    # Add HTB qdisc if it doesn't exist
    if ! tc qdisc add dev "${iface}" root handle 1: htb; then
      bashio::log.warning "Failed to add HTB qdisc for ${iface}"
      return 1
    fi
  fi

  # Check if filter already exists
  if tc filter show dev "${iface}" | grep -q "match gid ${tailscaled_gid}"; then
    bashio::log.notice "DSCP is already set for tailscaled (${ip_version})"
    return 0
  fi

  # Add filter to set DSCP
  if ! tc filter add dev "${iface}" parent 1: protocol ip prio 1 u32 \
    match gid ${tailscaled_gid} \
    action skbedit priority ${dscp_value}; then
    bashio::log.warning "Setting DSCP for tailscaled is unsuccessful (${ip_version})"
    return 1
  fi
}

# Prepare DSCP setting
if ! bashio::config.has_value "dscp" || \
  bashio::config.equals "dscp" 0;
then
  tailscaled_gid=0
else
  # Create a new group and let addgroup assign the GID
  if ! addgroup -S tailscaled; then
    bashio::log.warning "Failed to create tailscaled group"
    tailscaled_gid=0
  else
    # Get the assigned GID
    tailscaled_gid=$(getent group tailscaled | cut -d: -f3)
    adduser root tailscaled || true

    setup_dscp "IPv4"
    setup_dscp "IPv6"
  fi
fi

# Run Tailscale
# If exists, resolv.dnsmasq.conf pointing to the dummy dnsmasq will be mounted in place of the real resolv.conf only for tailscaled
# This will prevent the DNS at 100.100.100.100 to call back to hassio_dns causing a loop
if ! bashio::fs.file_exists "/etc/resolv.dnsmasq.conf"; then
  # Running the regular way, no resolv.conf replacement
  if bashio::debug ; then
    exec s6-setuidgid 0:${tailscaled_gid} /opt/tailscaled "${options[@]}"
  else
    bashio::log.notice "${TAILSCALED_LOGLEVEL_NOTICE}"
    s6-setuidgid 0:${tailscaled_gid} /opt/tailscaled "${options[@]}" 2>&1 \
      | stdbuf -i0 -oL -eL \
        sed -n -e '1,200p' \
          -e "201c${TAILSCALED_LOGLEVEL_MESSAGE}"
  fi
else
  # Using fake resolv.conf
  mv /etc/resolv.dnsmasq.conf /etc/resolv.for-tailscaled.conf
  if bashio::debug ; then
    exec unshare -m bash -c "mount --bind /etc/resolv.for-tailscaled.conf /etc/resolv.conf; exec s6-setuidgid 0:${tailscaled_gid} /opt/tailscaled $(printf "\"%s\" " "${options[@]}")"
  else
    bashio::log.notice "${TAILSCALED_LOGLEVEL_NOTICE}"
    unshare -m bash -c "mount --bind /etc/resolv.for-tailscaled.conf /etc/resolv.conf; exec s6-setuidgid 0:${tailscaled_gid} /opt/tailscaled $(printf "\"%s\" " "${options[@]}") 2>&1" \
      | stdbuf -i0 -oL -eL \
        sed -n -e '1,200p' \
          -e "201c${TAILSCALED_LOGLEVEL_MESSAGE}"
  fi
fi
